<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LazyScientist</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: white;
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }
        
        .header {
            background: linear-gradient(135deg, #0047AB 0%, #32CD32 100%);
            padding: 40px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .logo-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo {
            width: 50px;
            height: 50px;
        }
        
        .brand {
            display: flex;
            flex-direction: column;
        }
        
        .brand-name {
            font-size: 32px;
            font-weight: 700;
            color: white;
            letter-spacing: -0.5px;
        }
        
        .brand-tagline {
            font-size: 14px;
            color: rgba(255,255,255,0.9);
            font-weight: 300;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .search-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .search-box {
            display: flex;
            gap: 12px;
            margin-bottom: 0;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 16px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #0047AB;
            box-shadow: 0 0 0 3px rgba(0,71,171,0.1);
        }
        
        button {
            padding: 16px 35px;
            background: #0047AB;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        button:hover {
            background: #003580;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,71,171,0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #0047AB;
            display: none;
        }
        
        .loading p {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 15px;
        }
        
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #e0e0e0;
            border-top: 4px solid #0047AB;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results {
            margin-top: 20px;
        }
        
        .paper {
            background: white;
            padding: 24px;
            margin-bottom: 16px;
            border-radius: 12px;
            border-left: 5px solid #32CD32;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            transition: all 0.3s;
        }
        
        .paper:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }
        
        .paper-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }
        
        .paper-title {
            font-size: 19px;
            font-weight: 600;
            color: #1a1a1a;
            line-height: 1.4;
            flex: 1;
        }
        
        .relevance-badge {
            background: linear-gradient(135deg, #0047AB, #32CD32);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 12px;
            white-space: nowrap;
        }
        
        .paper-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        
        .paper-authors {
            color: #555;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .paper-year {
            color: #777;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .paper-link {
            display: inline-block;
            padding: 10px 20px;
            background: #32CD32;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .paper-link:hover {
            background: #28a428;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(50,205,50,0.3);
        }
        
        .icon {
            opacity: 0.7;
        }
        
        .more-btn-container {
            text-align: center;
            margin-top: 20px;
            display: none;
        }
        
        .more-btn {
            background: #32CD32;
        }
        
        .more-btn:hover {
            background: #28a428;
        }
        
        .info-box {
            background: #f8fffe;
            padding: 18px 20px;
            border-radius: 10px;
            margin-bottom: 24px;
            border-left: 4px solid #32CD32;
            border: 1px solid #e0f5e0;
        }
        
        .info-box p {
            color: #444;
            font-size: 14px;
            line-height: 1.7;
            margin: 0;
        }
        
        .counter {
            text-align: center;
            color: #666;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .error {
            background: #fff5f5;
            color: #c62828;
            padding: 18px 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #c62828;
            border: 1px solid #ffe0e0;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        
        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            font-size: 22px;
            color: #333;
            margin-bottom: 10px;
        }
        
        .empty-state p {
            font-size: 15px;
            color: #666;
            line-height: 1.6;
        }
        
        .footer {
            text-align: center;
            padding: 30px 20px;
            color: #999;
            font-size: 13px;
            border-top: 1px solid #f0f0f0;
            margin-top: 40px;
        }
        
        .url-list-section {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-bottom: 20px;
        }
        
        .url-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .url-list-header h3 {
            font-size: 18px;
            color: #333;
            font-weight: 600;
        }
        
        .copy-btn {
            padding: 10px 20px;
            background: #0047AB;
            font-size: 14px;
        }
        
        #urlList {
            width: 100%;
            min-height: 200px;
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.8;
            resize: vertical;
            background: #f9f9f9;
            color: #333;
        }
        
        #urlList:focus {
            outline: none;
            border-color: #0047AB;
        }
        
        .sort-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        
        .sort-label {
            font-weight: 600;
            color: #333;
            font-size: 15px;
        }
        
        .sort-btn {
            padding: 10px 20px;
            background: #f0f0f0;
            color: #555;
            font-size: 14px;
            border-radius: 8px;
        }
        
        .sort-btn:hover {
            background: #e0e0e0;
            transform: none;
            box-shadow: none;
        }
        
        .sort-btn.active {
            background: linear-gradient(135deg, #0047AB, #32CD32);
            color: white;
        }
        
        .sort-btn.active:hover {
            background: linear-gradient(135deg, #003580, #28a428);
        }
        
        .paper-citation {
            background: #f9f9f9;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            color: #555;
            line-height: 1.6;
            margin-bottom: 12px;
            font-style: italic;
            border-left: 3px solid #e0e0e0;
        }
        
        .citation-count {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #f0f7ff;
            color: #0047AB;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .paper-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 12px;
        }
        
        .delete-btn {
            padding: 6px 10px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            line-height: 1;
        }
        
        .delete-btn:hover {
            background: #cc0000;
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(255,68,68,0.4);
        }
        
        .delete-btn:active {
            transform: scale(0.95);
        }
        
        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .header {
                padding: 30px 15px;
            }
            
            .brand-name {
                font-size: 26px;
            }
            
            .brand-tagline {
                font-size: 12px;
            }
            
            .container {
                padding: 20px 15px;
            }
            
            .search-section {
                padding: 20px;
            }
            
            .search-box {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
            
            .sort-controls {
                flex-wrap: wrap;
                padding: 15px;
            }
            
            .sort-btn {
                flex: 1;
                min-width: 100px;
            }
            
            .paper {
                padding: 18px;
            }
            
            .paper-header {
                flex-direction: column;
                gap: 10px;
            }
            
            .paper-actions {
                margin-left: 0;
                justify-content: space-between;
                width: 100%;
            }
            
            .paper-title {
                font-size: 17px;
            }
            
            .paper-meta {
                flex-direction: column;
                gap: 8px;
            }
            
            .url-list-header {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }
            
            .copy-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo-container">
            <svg class="logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <!-- Simple, elegant logo: Book with a leaf -->
                <rect x="25" y="20" width="50" height="60" rx="3" fill="white" opacity="0.95"/>
                <rect x="30" y="25" width="40" height="50" rx="2" fill="none" stroke="white" stroke-width="2"/>
                <line x1="50" y1="25" x2="50" y2="75" stroke="white" stroke-width="2"/>
                <path d="M 70 35 Q 80 40 75 50 Q 70 60 65 55 Q 60 50 65 40 Q 70 30 70 35" fill="#32CD32" opacity="0.9"/>
            </svg>
            <div class="brand">
                <div class="brand-name">LazyScientist</div>
                <div class="brand-tagline">Smart research, effortless discovery</div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="search-section">
            <div class="info-box">
                <p><strong>How it works:</strong> Enter your research topic and get 10 relevant open-access papers ranked by relevance. Click "More" up to 4 times to load additional results (max 50 papers).</p>
            </div>
            
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Enter your research topic (e.g., machine learning, climate change, CRISPR)">
                <button id="searchBtn" onclick="searchPapers()">Search</button>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Searching for papers...</p>
        </div>
        
        <div class="sort-controls" id="sortControls" style="display: none;">
            <div class="sort-label">Sort by:</div>
            <button class="sort-btn active" onclick="sortByRelevance()">Relevance</button>
            <button class="sort-btn" onclick="sortByYear()">Year (Newest)</button>
            <button class="sort-btn" onclick="sortByCitations()">Citations (Most)</button>
        </div>
        
        <div class="results" id="results"></div>
        
        <div class="url-list-section" id="urlListSection" style="display: none;">
            <div class="url-list-header">
                <h3>URLs for NotebookLM</h3>
                <button class="copy-btn" onclick="copyAllUrls()">Copy All URLs</button>
            </div>
            <textarea id="urlList" readonly></textarea>
        </div>
        
        <div class="more-btn-container" id="moreBtnContainer">
            <button class="more-btn" id="moreBtn" onclick="loadMore()">Load More</button>
            <p class="counter" id="counter"></p>
        </div>
        
        <div class="footer">
            Powered by CORE API ‚Ä¢ Open Access Research
        </div>
    </div>

    <script>
        let currentPage = 0;
        let currentQuery = '';
        let moreClickCount = 0;
        const MAX_MORE_CLICKS = 4;
        const RESULTS_PER_PAGE = 10;
        let allPapers = []; // Store ALL papers here for re-ranking
        
        // CORE API endpoint (no API key needed for basic use)
        const CORE_API = 'https://core.ac.uk:443/api-v2/articles/search/';
        
        async function searchPapers() {
            const query = document.getElementById('searchInput').value.trim();
            
            if (!query) {
                alert('Please enter a research topic');
                return;
            }
            
            // Reset for new search
            currentQuery = query;
            currentPage = 0;
            moreClickCount = 0;
            allPapers = []; // Clear all stored papers
            document.getElementById('results').innerHTML = '';
            document.getElementById('moreBtnContainer').style.display = 'none';
            
            await fetchPapers();
        }
        
        async function loadMore() {
            if (moreClickCount >= MAX_MORE_CLICKS) {
                alert('Maximum number of results reached (50 papers)');
                return;
            }
            
            const previousCount = allPapers.length;
            moreClickCount++;
            currentPage++;
            await fetchPapers();
            
            // Smooth scroll to new papers after a brief delay
            setTimeout(() => {
                const papers = document.querySelectorAll('.paper');
                if (papers.length > previousCount) {
                    papers[previousCount].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 300);
            
            if (moreClickCount >= MAX_MORE_CLICKS) {
                document.getElementById('moreBtn').disabled = true;
                document.getElementById('moreBtn').textContent = 'Maximum Results Reached';
            }
        }
        
        async function fetchPapers() {
            const loading = document.getElementById('loading');
            const searchBtn = document.getElementById('searchBtn');
            const moreBtn = document.getElementById('moreBtn');
            
            loading.style.display = 'block';
            searchBtn.disabled = true;
            moreBtn.disabled = true;
            
            try {
                // Using CORE API v2 (free, no key required) - enable citations
                const url = `${CORE_API}${encodeURIComponent(currentQuery)}?page=${currentPage + 1}&pageSize=${RESULTS_PER_PAGE}&metadata=true&fulltext=true&citations=true&similar=false&duplicate=false&urls=true&faithfulMetadata=false&apiKey=demo`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch papers');
                }
                
                const data = await response.json();
                
                if (data.data && data.data.length > 0) {
                    // Add new papers to our collection
                    addPapersToCollection(data.data);
                    // Re-rank ALL papers and display them
                    rankAndDisplayAllPapers();
                    document.getElementById('moreBtnContainer').style.display = 'block';
                    updateCounter();
                } else {
                    if (currentPage === 0) {
                        document.getElementById('results').innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">üîç</div>
                                <h3>No papers found</h3>
                                <p>Try a different search term or broader topic. Make sure to use English keywords.</p>
                            </div>
                        `;
                    } else {
                        alert('No more papers found for this topic');
                    }
                }
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('results').innerHTML = '<div class="error">Error fetching papers. Please try again. Make sure you have an internet connection.</div>';
            } finally {
                loading.style.display = 'none';
                searchBtn.disabled = false;
                if (moreClickCount < MAX_MORE_CLICKS) {
                    moreBtn.disabled = false;
                }
            }
        }
        
        // Add new papers to our collection (only if they have full-text links)
        function addPapersToCollection(papers) {
            papers.forEach(paper => {
                const downloadUrl = paper.downloadUrl || 
                                  (paper.repositories && paper.repositories.length > 0 ? paper.repositories[0].url : null) ||
                                  (paper.urls && paper.urls.length > 0 ? paper.urls[0] : null);
                
                if (downloadUrl) {
                    // Add the paper with its download URL
                    allPapers.push({
                        ...paper,
                        downloadUrl: downloadUrl
                    });
                }
            });
        }
        
        // Calculate relevance score for a paper
        function calculateRelevanceScore(paper) {
            let score = 0;
            
            // Get search terms (split by spaces, make lowercase)
            const searchTerms = currentQuery.toLowerCase().split(' ').filter(term => term.length > 2);
            
            const title = (paper.title || '').toLowerCase();
            const description = (paper.description || '').toLowerCase();
            
            // Score based on title matches (worth 10 points each)
            searchTerms.forEach(term => {
                const titleMatches = (title.match(new RegExp(term, 'g')) || []).length;
                score += titleMatches * 10;
            });
            
            // Score based on description matches (worth 2 points each)
            searchTerms.forEach(term => {
                const descMatches = (description.match(new RegExp(term, 'g')) || []).length;
                score += descMatches * 2;
            });
            
            // Bonus for recent papers (max 5 points)
            const year = parseInt(paper.year) || 2000;
            const currentYear = new Date().getFullYear();
            if (year >= currentYear - 5) {
                score += 5; // Published in last 5 years
            } else if (year >= currentYear - 10) {
                score += 3; // Published in last 10 years
            }
            
            return score;
        }
        
        // Rank all papers and display them
        function rankAndDisplayAllPapers() {
            // Calculate score for each paper
            allPapers.forEach(paper => {
                paper.relevanceScore = calculateRelevanceScore(paper);
            });
            
            // Sort by relevance score (highest first)
            allPapers.sort((a, b) => b.relevanceScore - a.relevanceScore);
            
            // Clear and display all papers in new order
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            
            allPapers.forEach((paper, index) => {
                const paperDiv = document.createElement('div');
                paperDiv.className = 'paper';
                
                const title = paper.title || 'Untitled';
                const authors = paper.authors && paper.authors.length > 0 
                    ? paper.authors.map(a => a.name || a).join(', ') 
                    : 'Unknown authors';
                const year = paper.year || paper.publishedDate || 'Year unknown';
                
                // Calculate relevance level for display
                const maxScore = allPapers[0].relevanceScore;
                const relativeScore = maxScore > 0 ? Math.round((paper.relevanceScore / maxScore) * 100) : 100;
                
                // Generate APA citation
                const apaCitation = generateAPACitation(paper);
                
                // Get citation count
                const citationCount = paper.citationCount || 0;
                
                paperDiv.innerHTML = `
                    <div class="paper-header">
                        <div class="paper-title">${escapeHtml(title)}</div>
                        <div class="paper-actions">
                            <div class="relevance-badge">${relativeScore}% match</div>
                            <button class="delete-btn" onclick="deletePaper(${index})" title="Remove from list">‚úï</button>
                        </div>
                    </div>
                    <div class="paper-citation">${apaCitation}</div>
                    <div class="paper-meta">
                        <div class="paper-authors"><span class="icon">üë§</span> ${escapeHtml(authors)}</div>
                        <div class="paper-year"><span class="icon">üìÖ</span> ${escapeHtml(year.toString())}</div>
                        <div class="citation-count">üìä ${citationCount} citations</div>
                    </div>
                    <a href="${escapeHtml(paper.downloadUrl)}" target="_blank" class="paper-link">View Full Text ‚Üí</a>
                `;
                
                resultsDiv.appendChild(paperDiv);
            });
            
            // Update URL list
            updateUrlList();
            
            // Show sort controls
            document.getElementById('sortControls').style.display = 'flex';
        }
        
        // Generate APA citation
        function generateAPACitation(paper) {
            const title = paper.title || 'Untitled';
            const year = paper.year || paper.publishedDate || 'n.d.';
            
            // Format authors for APA
            let authorString = '';
            if (paper.authors && paper.authors.length > 0) {
                const authors = paper.authors.map(a => {
                    const name = a.name || a;
                    // Try to format as "Last, F." if possible
                    const parts = name.trim().split(' ');
                    if (parts.length > 1) {
                        const lastName = parts[parts.length - 1];
                        const initials = parts.slice(0, -1).map(p => p.charAt(0).toUpperCase() + '.').join(' ');
                        return `${lastName}, ${initials}`;
                    }
                    return name;
                });
                
                if (authors.length === 1) {
                    authorString = authors[0];
                } else if (authors.length === 2) {
                    authorString = `${authors[0]}, & ${authors[1]}`;
                } else if (authors.length <= 20) {
                    authorString = authors.slice(0, -1).join(', ') + ', & ' + authors[authors.length - 1];
                } else {
                    // More than 20 authors - use et al.
                    authorString = authors.slice(0, 19).join(', ') + ', ... ' + authors[authors.length - 1];
                }
            } else {
                authorString = 'Unknown Author';
            }
            
            // Journal or source
            const journal = paper.journals && paper.journals.length > 0 ? paper.journals[0].title : '';
            const publisher = paper.publisher || '';
            
            let citation = `${authorString} (${year}). ${title}.`;
            
            if (journal) {
                citation += ` <em>${journal}</em>.`;
            } else if (publisher) {
                citation += ` ${publisher}.`;
            }
            
            return citation;
        }
        
        // Sorting functions
        let currentSort = 'relevance';
        
        function sortByRelevance() {
            currentSort = 'relevance';
            updateSortButtons();
            allPapers.sort((a, b) => b.relevanceScore - a.relevanceScore);
            displayPapers();
        }
        
        function sortByYear() {
            currentSort = 'year';
            updateSortButtons();
            allPapers.sort((a, b) => {
                const yearA = parseInt(a.year) || 0;
                const yearB = parseInt(b.year) || 0;
                return yearB - yearA; // Newest first
            });
            displayPapers();
        }
        
        function sortByCitations() {
            currentSort = 'citations';
            updateSortButtons();
            allPapers.sort((a, b) => {
                const citA = a.citationCount || 0;
                const citB = b.citationCount || 0;
                return citB - citA; // Most citations first
            });
            displayPapers();
        }
        
        function updateSortButtons() {
            document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
            if (currentSort === 'relevance') {
                document.querySelectorAll('.sort-btn')[0].classList.add('active');
            } else if (currentSort === 'year') {
                document.querySelectorAll('.sort-btn')[1].classList.add('active');
            } else if (currentSort === 'citations') {
                document.querySelectorAll('.sort-btn')[2].classList.add('active');
            }
        }
        
        function displayPapers() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            
            allPapers.forEach((paper, index) => {
                const paperDiv = document.createElement('div');
                paperDiv.className = 'paper';
                
                const title = paper.title || 'Untitled';
                const authors = paper.authors && paper.authors.length > 0 
                    ? paper.authors.map(a => a.name || a).join(', ') 
                    : 'Unknown authors';
                const year = paper.year || paper.publishedDate || 'Year unknown';
                
                // Calculate relevance level for display
                const maxScore = Math.max(...allPapers.map(p => p.relevanceScore));
                const relativeScore = maxScore > 0 ? Math.round((paper.relevanceScore / maxScore) * 100) : 100;
                
                // Generate APA citation
                const apaCitation = generateAPACitation(paper);
                
                // Get citation count
                const citationCount = paper.citationCount || 0;
                
                paperDiv.innerHTML = `
                    <div class="paper-header">
                        <div class="paper-title">${escapeHtml(title)}</div>
                        <div class="paper-actions">
                            <div class="relevance-badge">${relativeScore}% match</div>
                            <button class="delete-btn" onclick="deletePaper(${index})" title="Remove from list">‚úï</button>
                        </div>
                    </div>
                    <div class="paper-citation">${apaCitation}</div>
                    <div class="paper-meta">
                        <div class="paper-authors"><span class="icon">üë§</span> ${escapeHtml(authors)}</div>
                        <div class="paper-year"><span class="icon">üìÖ</span> ${escapeHtml(year.toString())}</div>
                        <div class="citation-count">üìä ${citationCount} citations</div>
                    </div>
                    <a href="${escapeHtml(paper.downloadUrl)}" target="_blank" class="paper-link">View Full Text ‚Üí</a>
                `;
                
                resultsDiv.appendChild(paperDiv);
            });
            
            // Update URL list after displaying
            updateUrlList();
        }
        
        // Delete a paper from the list
        function deletePaper(index) {
            if (confirm('Remove this paper from your list?')) {
                allPapers.splice(index, 1);
                displayPapers();
                updateCounter();
            }
        }
        
        // Update the URL list for copying - always reflects current display order
        function updateUrlList() {
            const urlList = allPapers.map(paper => paper.downloadUrl).join('\n');
            document.getElementById('urlList').value = urlList;
            
            if (allPapers.length > 0) {
                document.getElementById('urlListSection').style.display = 'block';
            } else {
                document.getElementById('urlListSection').style.display = 'none';
            }
        }
        
        // Copy all URLs to clipboard
        function copyAllUrls() {
            const urlList = document.getElementById('urlList');
            urlList.select();
            document.execCommand('copy');
            
            // Visual feedback
            const copyBtn = document.querySelector('.copy-btn');
            const originalText = copyBtn.textContent;
            copyBtn.textContent = 'Copied!';
            copyBtn.style.background = '#32CD32';
            
            setTimeout(() => {
                copyBtn.textContent = originalText;
                copyBtn.style.background = '#0047AB';
            }, 2000);
        }
        
        function updateCounter() {
            const totalPapers = allPapers.length;
            const remaining = MAX_MORE_CLICKS - moreClickCount;
            
            let sortText = 'relevance';
            if (currentSort === 'year') sortText = 'year';
            if (currentSort === 'citations') sortText = 'citations';
            
            document.getElementById('counter').textContent = 
                `Showing ${totalPapers} papers (sorted by ${sortText}) | ${remaining} more loads available`;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Allow Enter key to search
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchPapers();
            }
        });
    </script>
</body>
</html>
